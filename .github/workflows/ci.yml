name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Verify Go installation version
      run: go version

    - name: Build tcp-server
      run: go build -v ./tcp-server/main.go

    - name: Build thread-pool
      run: go build -v ./threadpool/main.go

    - name: Run go vet
      run: go vet ./tcp-server
  
  Check-code-formatting:
    name: Check golang code formatting
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Verify Go installation version
      run: go version

    - name: Check code formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted. Run: gofmt -s -w ."
          gofmt -s -l .
          exit 1
        fi
    
    # - name: Download Go dependencies
    #   run: go mod download
    #   working-directory: ./tcp-server

    # - name: Run tests
    #   run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    #   working-directory: ./tcp-server
    
    # - name: Update coverage to Codecov
    #   uses: codecov/codecov-action@v3
    #   with:
    #     file: ./coverage.out
    #     flags: unittests
  
  # lint:
  #   name: Lint
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       go-version: ['1.24', '1.25']

  #   steps:
  #   - name: Check out code
  #     uses: actions/checkout@v4

  #   - name: Set up Go
  #     uses: actions/setup-go@v5
  #     with:
  #       go-version: ${{ matrix.go-version }}

  #   - name: golangci-lint
  #     uses: golangci/golangci-lint-action@v3
  #     with:
  #       version: latest
